<html>
<head>
<script src="http://localhost:8801/centro/v1/primus/primus.js"></script>
<script src="../../dist/centro.js"></script>
<script>
function connect()
{
    var params = new URLSearchParams(window.location.search);

    centro.separate_auth(
    {
        token: params.get('token')
    }, function (err, userpass, make_client)
    {
        if (err)
        {
            throw(err);
        }

        var primus = new Primus('http://' + userpass + '@localhost:8801'),
            client = make_client(new centro.PrimusDuplex(primus));

        client.on('ready', function ()
        {
            this.subscribe(params.get('topic'), function (s)
            {
                var bufs = [];

                s.on('end', function ()
                {
                    var div = document.createElement('div');
                    div.appendChild(document.createTextNode(
                            centro.Buffer.concat(bufs).toString()));
                    document.body.appendChild(div);
                });

                s.on('readable', function ()
                {
                    var data;
                    while ((data = s.read()) !== null)
                    {
                        bufs.push(data);
                    }
                });
            }, function (err)
            {
                if (err)
                {
                    throw(err);
                }
            });
        });
    });

}
</script>
</head>
<body onload='connect()'>
</body>
</html>
